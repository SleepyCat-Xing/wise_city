# 基于多模态AI的违章建筑智能检测与管理系统 - 启动指南

## 环境要求

### 系统要求
- Python 3.9+
- Docker & Docker Compose
- Git

### 硬件要求
- 内存：至少8GB RAM
- GPU：可选，用于加速AI推理
- 存储：至少10GB可用空间

## 快速启动

### 1. 克隆项目（如果需要）
```bash
git clone <repository-url>
cd violation_detection_system
```

### 2. 环境配置
```bash
# 复制环境配置文件
cp .env.example .env

# 编辑配置文件
# 修改数据库密码、JWT密钥等敏感信息
```

### 3. 使用Docker启动（推荐）

#### 开发环境
```bash
# 构建并启动所有服务
docker-compose -f docker-compose.dev.yml up --build

# 后台启动
docker-compose -f docker-compose.dev.yml up -d --build
```

#### 生产环境
```bash
# 构建并启动所有服务
docker-compose up --build

# 后台启动
docker-compose up -d --build
```

### 4. 本地开发启动

#### 创建虚拟环境
```bash
# Windows
python -m venv venv
venv\\Scripts\\activate

# Linux/Mac
python -m venv venv
source venv/bin/activate
```

#### 安装依赖
```bash
pip install -r requirements.txt

# 或者安装开发依赖
pip install -e .[dev]
```

#### 启动服务
```bash
# 启动FastAPI服务
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

# 或者使用Python直接运行
python -m app.main
```

## 服务访问地址

### 主要服务
- **API服务**: http://localhost:8000
- **API文档**: http://localhost:8000/docs
- **ReDoc文档**: http://localhost:8000/redoc
- **健康检查**: http://localhost:8000/health

### 开发工具（仅开发环境）
- **PgAdmin**: http://localhost:5050
  - 用户名：admin@example.com
  - 密码：admin123
- **Redis Commander**: http://localhost:8081

### 数据库连接信息
- **PostgreSQL**: localhost:5432
  - 数据库：violation_detection
  - 用户名：postgres
  - 密码：password
- **Redis**: localhost:6379

## API使用示例

### 1. 健康检查
```bash
curl -X GET "http://localhost:8000/health"
```

### 2. 获取模型信息
```bash
curl -X GET "http://localhost:8000/api/v1/detection/model/info"
```

### 3. 单张图片检测
```bash
curl -X POST "http://localhost:8000/api/v1/detection/detect/image" \\
  -H "Content-Type: multipart/form-data" \\
  -F "file=@/path/to/image.jpg" \\
  -F "confidence_threshold=0.5"
```

### 4. 批量图片检测
```bash
curl -X POST "http://localhost:8000/api/v1/detection/detect/batch" \\
  -H "Content-Type: multipart/form-data" \\
  -F "files=@/path/to/image1.jpg" \\
  -F "files=@/path/to/image2.jpg" \\
  -F "confidence_threshold=0.5"
```

## 开发工具使用

### 代码格式化
```bash
# 使用black格式化代码
black app tests

# 使用isort排序导入
isort app tests

# 使用flake8检查代码质量
flake8 app tests

# 使用mypy进行类型检查
mypy app
```

### 运行测试
```bash
# 运行所有测试
pytest

# 运行特定测试文件
pytest tests/test_detection.py

# 运行测试并生成覆盖率报告
pytest --cov=app --cov-report=html
```

### Git提交前检查
```bash
# 安装pre-commit钩子
pre-commit install

# 手动运行pre-commit检查
pre-commit run --all-files
```

## 故障排除

### 常见问题

#### 1. Docker构建失败
```bash
# 清理Docker缓存
docker system prune -a

# 重新构建镜像
docker-compose build --no-cache
```

#### 2. 端口占用
```bash
# 检查端口占用情况
netstat -ano | findstr :8000  # Windows
lsof -i :8000  # Linux/Mac

# 修改docker-compose.yml中的端口映射
```

#### 3. 依赖安装失败
```bash
# 升级pip
pip install --upgrade pip

# 清理pip缓存
pip cache purge

# 使用清华镜像源
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

#### 4. AI模型加载失败
- 检查models目录是否存在
- 确认模型文件路径配置正确
- 网络连接正常（用于下载预训练模型）
- 系统内存充足

### 日志查看
```bash
# 查看Docker容器日志
docker-compose logs api
docker-compose logs postgres
docker-compose logs redis

# 实时查看日志
docker-compose logs -f api

# 查看本地日志文件
tail -f logs/app.log
```

### 性能监控
```bash
# 查看系统状态
curl -X GET "http://localhost:8000/api/v1/system/health"

# 查看统计信息
curl -X GET "http://localhost:8000/api/v1/system/stats/summary"
```

## 部署建议

### 生产环境配置
1. 修改默认密码和密钥
2. 启用HTTPS
3. 配置防火墙规则
4. 设置日志轮转
5. 配置监控告警
6. 定期备份数据

### 扩展方案
1. 使用负载均衡器
2. 配置多个API实例
3. 使用外部Redis集群
4. 使用PostgreSQL主从复制
5. 添加CDN加速静态资源

## 更多信息

- **项目需求文档**: 项目需求与技术设计文档.md
- **API文档**: http://localhost:8000/docs
- **技术支持**: 联系开发团队